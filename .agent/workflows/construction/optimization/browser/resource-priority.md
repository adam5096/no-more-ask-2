## 🚀 Web 資源載入優化開發指南 (Resource Loading Guide)

### 1. 核心技術對照表

在選擇技術前，請先確認資源的**急迫性**與**相依性**。

| 模式 | 標籤與屬性 | 核心目的 | 下載權重 | 執行/使用時機 |
| --- | --- | --- | --- | --- |
| **Normal** | `<script src="...">` | 最快執行，但不計代價 | 高 | 下載完立即執行，會中斷 HTML 解析 |
| **async** | `<script async src="...">` | 儘早執行，不理會順序 | 低 | 下載完立即執行，不保證與其他腳本的先後順序 |
| **defer** | `<script defer src="...">` | 穩定執行，不阻塞解析 | 低 | HTML 解析完後，按 HTML 出現順序執行 |
| **preload** | `<link rel="preload">` | **當前頁面**關鍵資源提前下載 | **最高** | 下載後存入快取，需搭配其他標籤執行 |
| **prefetch** | `<link rel="prefetch">` | **未來頁面**資源預熱 | 最低 | 瀏覽器閒置時下載，供下一頁使用 |

---

### 2. 適用場景與開發建議

#### A. `defer`：現代網頁的主力 (最推薦)

* **適用場景**：
* 主程式邏輯（Main Bundle）。
* 需要操作 DOM 的腳本。
* 有相依關係的套件（如：先載入 jQuery，再載入套件）。


* **開發指南**：
* **一律將 `defer` 放在 `<head>` 內**。這能讓下載與解析 HTML 同步開始，但執行會延後。
* 避免在 `defer` 腳本中寫 `document.write()`。



#### B. `async`：獨立的第三方工具

* **適用場景**：
* 不影響頁面呈現的追蹤代碼（Google Analytics、Facebook Pixel）。
* 獨立的廣告插件。


* **開發指南**：
* **限制條件**：腳本內容不可與你的主程式有順序依賴，也不應依賴 DOM 是否完全解析。
* 若有多個 `async` 腳本，誰先下載完就先跑，不保證順序。



#### C. `preload`：關鍵資源的搶跑道

* **適用場景**：
* **字體檔案 (Fonts)**：解決文字閃爍問題（FOIT）。
* **CSS 內引用的背景圖**：預解析掃描器抓不到 CSS 內的 URL，需手動 preload。
* **關鍵路徑的 JS/CSS**。


* **開發指南**：
* **限制條件**：必須使用 `as` 屬性（如 `as="style"`, `as="font"`）否則瀏覽器不知道優先級。
* **注意**： preload 過多資源會搶佔頻寬，反而拖慢首屏渲染。



#### D. `prefetch`：為了下一階段的預備

* **適用場景**：
* 使用者登入後，預取「個人儀表板」的 JS 檔案。
* 多頁面表單的下一步資源。


* **開發指南**：
* 適用於頻寬充足且預測使用者行為準確率高的情況。



---

### 3. 使用限制與常見坑洞 (Pitfalls)

1. **重複下載風險**：
如果你對同一個資源同時使用 `preload` 和 `script`，但 `as` 屬性沒寫對，瀏覽器可能會**下載兩次**。
2. **字體跨域問題**：
使用 `preload` 載入字體時，即使是同網域，也必須加上 `crossorigin` 屬性：
```html
<link rel="preload" href="font.woff2" as="font" type="font/woff2" crossorigin>

```


3. **Module 腳本預設行行為**：
現代開發常用的 `<script type="module">` **預設就帶有 `defer` 特性**，因此不需額外加 `defer`（除非你想加 `async`）。

---

### 4. 決策流程圖 (Cheat Sheet)

> **我要載入一個資源...**
> 1. 是**現在這頁**就要用的嗎？
> * 否 ➔ **prefetch**
> * 是 ➔ 進入第 2 步
> 
> 
> 2. 是**極度關鍵**（字體、CSS、首屏首要圖片）嗎？
> * 是 ➔ **preload**
> * 否 ➔ 進入第 3 步（通常是 JS）
> 
> 
> 3. 這個 JS 需要**操作 DOM** 或**有順序性**嗎？
> * 是 ➔ **defer**
> * 否（如追蹤碼） ➔ **async**
> 
> 
> 
> 

---