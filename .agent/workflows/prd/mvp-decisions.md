# MVP 階段決策記錄

> **決策日期**：2024  
> **決策原則**：優先選擇施工難度較低的方案，符合 MVP 快速迭代需求  
> **相關文檔**：[ORCA 分析文檔](./orca-analysis-v1.md)

---

## 📋 目錄

1. [對象層級決策](#對象層級決策)
2. [關係層級決策](#關係層級決策)
3. [功能層級決策](#功能層級決策)
4. [屬性層級決策](#屬性層級決策)
5. [BFF 聚合決策](#bff-聚合決策)

---

## 對象層級決策

### 決策 1：User 與 Helper 的關係

**問題**：一個 User 是否可以有多個 Helper 身份？

**✅ 決策**：一個 User 只能有一個 Helper 身份（Phase 1/MVP 階段）

**理由**：
- 簡化資料模型，降低開發複雜度
- MVP 階段不需要多身份管理功能
- 後續可擴展為多身份支援

**實作**：
- User 與 Helper 為一對一關係，唯一約束
- `Helper.userId` 為唯一索引

**影響範圍**：
- 資料庫設計
- 註冊流程
- 角色切換邏輯

---

### 決策 2：RescueRequest 的匹配邏輯

**問題**：救援請求如何匹配 Helper？用戶是否可以選擇 Helper？

**✅ 決策**：一對一自動匹配（系統自動匹配，用戶無法選擇）

**理由**：
- 施工難度較低，無需選擇介面與候選列表管理
- 降低用戶決策負擔
- 符合 MVP 快速迭代需求

**實作**：
- 系統根據地理位置、技能、狀態自動匹配單一 Helper
- 匹配邏輯由後端團隊實作
- 匹配成功後發送通知

**影響範圍**：
- 匹配演算法設計
- UI 流程（無需選擇介面）
- 通知系統

---

### 決策 3：Gathering 與 VentPost 的關係

**問題**：VentPost 是否必須關聯到 Gathering？

**✅ 決策**：VentPost 可以獨立存在，也可以選擇關聯到 Gathering

**理由**：
- 提供彈性，滿足不同使用場景
- 用戶可以單獨發布貼文，也可以為聚會創建貼文
- 不增加實作複雜度

**實作**：
- `VentPost.relatedGatheringId` 為可選欄位
- 如果關聯，貼文會顯示在聚會詳情頁

**影響範圍**：
- 貼文發布流程
- 聚會詳情頁 UI
- 資料查詢邏輯

---

## 關係層級決策

### 決策 4：MapLayer 的數據來源

**問題**：MapLayer 是獨立對象還是視圖層？

**✅ 決策**：MapLayer 是視圖層，數據來源於其他對象（RescueRequest, Helper, Gathering）

**理由**：
- 避免資料重複，保持資料一致性
- 地圖顯示是其他對象的視圖呈現
- 降低資料同步複雜度

**實作**：
- MapLayer 透過 `relatedObjectId` 與 `relatedObjectType` 關聯到實際對象
- 地圖數據由其他對象的位置資訊生成
- 不儲存重複的位置資訊

**影響範圍**：
- 地圖服務設計
- 資料查詢邏輯
- 位置更新流程

---

### 決策 5：Notification 的觸發機制

**問題**：通知的觸發規則如何管理？

**✅ 決策**：建立 NotificationRule 對象來管理觸發規則

**理由**：
- 可擴展性高，便於後續調整通知邏輯
- 支援不同類型的通知規則
- 便於維護和測試

**實作**：
- 由後端團隊實作 NotificationRule 機制
- 支援規則的動態配置
- 可設定通知頻率、條件等

**影響範圍**：
- 通知系統架構
- 後端服務設計
- 系統配置管理

---

## 功能層級決策

### 決策 6：ResponseScript 的實作方式

**問題**：應對腳本如何生成？是否使用 AI？

**✅ 決策**：腳本由前端工程師或 API SERVER 提供（不依賴 AI 生成）

**理由**：
- MVP 階段降低技術複雜度
- 避免 AI 服務整合成本
- 腳本內容可以預先設計和優化

**實作**：
- 腳本內容預先定義，根據輸入問題與語氣返回對應腳本
- 可以建立腳本資料庫，支援擴展
- 後續可升級為 AI 生成

**影響範圍**：
- 應對錦囊功能實作
- 腳本資料庫設計
- 前端/API SERVER 開發

---

### 決策 7：診斷報告的分享機制

**問題**：診斷報告如何分享給他人？

**✅ 決策**：MVP 階段採用私密連結（token 機制）

**理由**：
- 保護用戶隱私，降低權限管理複雜度
- 不需要複雜的權限系統
- 符合 MVP 快速迭代需求

**實作**：
- 使用 `shareToken` 生成私密連結
- 可設定過期時間
- 連結格式：`/diagnostic-report/{shareToken}`

**影響範圍**：
- 分享功能設計
- URL 路由設計
- 權限驗證邏輯

---

## 屬性層級決策

### 決策 8：地理位置的精確度

**問題**：不同對象的地理位置是否需要相同的精確度？

**✅ 決策**：RescueRequest 需要精確座標，MapLayer 可以模糊化

**理由**：
- 救援請求需要精確位置進行匹配
- 地圖顯示可接受模糊化以保護隱私
- 平衡功能需求與隱私保護

**實作**：
- `RescueRequest.location` 使用精確座標
- `MapLayer.coordinates` 可進行座標模糊化處理（例如：偏移 50-100 公尺）
- 模糊化邏輯由後端實作

**影響範圍**：
- 位置匹配演算法
- 地圖顯示邏輯
- 隱私保護機制

---

### 決策 9：匿名機制的實作

**問題**：匿名貼文是否保存用戶資訊？

**✅ 決策**：保存 userId 用於後台管理，但對外顯示為匿名

**理由**：
- 平衡用戶隱私與系統管理需求
- 需要追蹤違規內容
- 不影響用戶體驗

**實作**：
- `VentPost.userId` 必須保存
- `isAnonymous` 為 true 時對外不顯示用戶資訊
- 後台管理系統可以查看真實用戶

**影響範圍**：
- 貼文顯示邏輯
- 後台管理系統
- 資料查詢權限

---

### 決策 10：Line 整合的範圍

**問題**：哪些通知需要發送到 Line？

**✅ 決策**：用戶可設定通知偏好，選擇哪些類型要發送到 Line

**理由**：
- 提供用戶控制權，避免通知過載
- 不同用戶對通知的需求不同
- 符合用戶體驗最佳實踐

**實作**：
- User 設定通知偏好（可在個人設定中調整）
- 系統根據偏好決定是否發送 Line 通知
- 支援即時調整

**影響範圍**：
- 用戶設定頁面
- 通知發送邏輯
- Line 整合服務

---

## BFF 聚合決策

### 決策 11：數據載入策略

**問題**：不同頁面的資料應該如何載入？聚合還是分開？

**✅ 決策**：
- **救援請求詳情頁**：需要 RescueRequest + Helper 資訊 + 地圖位置（聚合）
- **個人儀表板**：可以分開載入（RescueRequest 列表、Gathering 列表、Notification 列表）
- **地圖頁面**：可以分開載入不同圖層（救援點、閒人、避難空間）

**理由**：
- 平衡載入速度與資料完整性
- 支援獨立 Skeleton 載入
- 避免過度聚合導致載入緩慢

**實作**：
- 參考 `docs/bff-paths.md` 中的頁面複雜度分析
- 根據 UI 邏輯區塊決定聚合策略
- 複雜頁面採用獨立載入，簡單頁面採用聚合

**影響範圍**：
- BFF 路徑設計
- 前端載入邏輯
- 用戶體驗優化

---

### 決策 12：頁面複雜度判斷

**問題**：如何判斷頁面應該使用哪種 BFF 聚合策略？

**✅ 決策**：
- **Simple（1:1）**：邊界說明書頁面、應對錦囊頁面
- **Standard（1:2-3）**：救援請求詳情頁（請求 + Helper + 地圖）
- **Complex（1:N）**：個人儀表板（多個獨立區塊）、戰況地圖（多個圖層）

**理由**：
- 根據 UI 邏輯區塊決定 BFF 路徑數量
- 避免過度聚合
- 支援漸進式載入

**實作**：
- 參考 `docs/bff-paths.md` 中的 BFF 路徑設計
- 參考 `.cursor/rules/routing/architectural-rules.mdc` 中的複雜度定義
- 每個獨立 UI 區塊對應一個 BFF 路徑

**影響範圍**：
- BFF 架構設計
- 前端開發模式
- 載入效能優化

---

## Phase 結構決策

### 決策 13：Phase 結構重新規劃

**問題**：如何減少 MVP 工作量並分散開發負擔？

**✅ 決策**：將功能拆分為 4 個 Phase（Phase 1-4），大幅減少 Phase 1（MVP）範圍

**理由**：
- Phase 1（MVP）從 18 頁減少到 7-8 頁（減少約 55%）
- 分散開發負擔，每個 Phase 工作量更均衡
- 保持 Phase 1 能驗證核心價值（救援功能與 Helper 匹配）
- 符合快速迭代與風險控制需求

**Phase 結構**：

**Phase 1（MVP - 最精簡核心）**：約 7-8 個頁面
- 認證系統：登入、註冊
- 個人儀表板：簡化版（僅用戶資訊 + 快速操作）
- 通知系統：通知中心
- 救援功能：建立請求、請求詳情
- Helper 功能：Helper 註冊、Helper 儀表板

**Phase 2（擴展核心功能）**：約 6-7 個頁面
- 個人儀表板：完整版（加入救援請求列表、聚會列表）
- 個人資料：個人資料設定
- 通知系統：通知設定
- 救援功能：選擇 Helper
- Helper 功能：Helper 檔案、Helper 設定
- 應對錦囊：應對錦囊
- 取暖牆：貼文流、發起聚會、聚會列表、聚會詳情

**Phase 3（診斷與地圖）**：約 3 個頁面
- 角色診斷：開始測驗、診斷報告
- 實況地圖：實況地圖

**Phase 4（邊界管理）**：約 2 個頁面
- 邊界說明書：邊界說明書、邊界分享頁

**功能移出理由**：

1. **個人儀表板簡化**：
   - 移出：救援請求列表、聚會列表
   - 理由：這些可以在對應的功能頁面查看，MVP 階段不需要在儀表板整合

2. **Helper 功能簡化**：
   - 移出：Helper 檔案、Helper 設定
   - 理由：MVP 階段只需要基本的 Helper 註冊與接案功能

3. **救援功能簡化**：
   - 移出：選擇 Helper 頁面
   - 理由：根據決策 2，系統自動匹配，用戶無需選擇介面

4. **通知系統簡化**：
   - 移出：通知設定
   - 理由：MVP 階段可以使用預設通知設定

5. **應對錦囊與取暖牆移出**：
   - 移出：應對錦囊、取暖牆（原 P1 功能）
   - 理由：這些不是核心救援功能，可以延後實作

**實作**：
- 更新所有文檔中的 Phase 分類
- 確保 Phase 之間的依賴關係清晰
- 保持功能完整性，避免過度簡化

**影響範圍**：
- PRD 功能清單
- Site Map 頁面狀態
- 用戶流程優先級
- 開發時程規劃

---

## 決策追蹤

| 決策編號 | 決策內容 | 狀態 | 影響範圍 | 後續行動 |
|---------|---------|------|----------|----------|
| 1 | User 與 Helper 一對一關係 | ✅ 已確認 | 資料庫、註冊流程 | 實作唯一約束 |
| 2 | 一對一自動匹配 | ✅ 已確認 | 匹配演算法、UI | 設計匹配邏輯 |
| 3 | VentPost 可選關聯 Gathering | ✅ 已確認 | 貼文發布流程 | 實作可選欄位 |
| 4 | MapLayer 為視圖層 | ✅ 已確認 | 地圖服務 | 設計關聯機制 |
| 5 | NotificationRule 機制 | ✅ 已確認 | 通知系統 | 後端實作 |
| 6 | 腳本預先定義 | ✅ 已確認 | 應對錦囊 | 建立腳本庫 |
| 7 | 私密連結分享 | ✅ 已確認 | 分享功能 | 實作 token 機制 |
| 8 | 位置精確度差異化 | ✅ 已確認 | 位置服務 | 實作模糊化 |
| 9 | 匿名機制實作 | ✅ 已確認 | 貼文系統 | 實作顯示邏輯 |
| 10 | Line 通知偏好 | ✅ 已確認 | 通知系統 | 實作偏好設定 |
| 11 | 數據載入策略 | ✅ 已確認 | BFF 設計 | 設計 BFF 路徑 |
| 12 | 頁面複雜度判斷 | ✅ 已確認 | BFF 架構 | 應用複雜度規則 |
| 13 | Phase 結構重新規劃 | ✅ 已確認 | 功能範圍、開發時程 | 更新所有相關文檔 |

---

**文檔版本**：v1.0  
**最後更新**：2024  
**維護者**：待指定

